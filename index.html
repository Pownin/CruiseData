<script>
  let DATA = [];

  const loadBtn = document.getElementById("load");
  const q = document.getElementById("q");
  const out = document.getElementById("out");
  const status = document.getElementById("status");

  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }

  function textOf(item) { return JSON.stringify(item).toLowerCase(); }

  function render(list) {
    out.innerHTML = "";
    const frag = document.createDocumentFragment();

    list.slice(0, 500).forEach(item => {
      const url = item.viewDetailsUrl || item.view_details_url || item.url || item.link || null;
      const title = item.title || item.name || item.itineraryName || item.cruiseName || "Cruise";
      const dates = item.date || item.startDate || item.sailDate || item.departureDate || "";

      const safeUrl = (typeof url === "string" && url.startsWith("http")) ? url : null;

      const div = document.createElement("div");
      div.className = "row";
      div.innerHTML = `
        <div><b>${escapeHtml(String(title))}</b></div>
        ${safeUrl ? `<div><a href="${safeUrl}" target="_blank" rel="noopener">Open View Details</a></div>` : ""}
        <div class="meta">${escapeHtml(String(dates))}</div>
      `;
      frag.appendChild(div);
    });

    out.appendChild(frag);
    status.textContent = `Showing ${Math.min(list.length, 500)} of ${list.length} matches`;
  }

  function filter() {
    const needle = q.value.trim().toLowerCase();
    if (!needle) return render(DATA);
    const filtered = DATA.filter(item => textOf(item).includes(needle));
    render(filtered);
  }

  q.addEventListener("input", filter);

  loadBtn.addEventListener("click", async () => {
    try {
      status.textContent = "Loadingâ€¦";

      // IMPORTANT: relative path so it works on GitHub Pages project sites
      const res = await fetch("./cruiseDataNew.json", { cache: "no-store" });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      DATA = await res.json();

      q.disabled = false;
      q.focus();
      render(DATA);

      status.textContent = `Loaded ${DATA.length} items`;
    } catch (e) {
      status.textContent = `Failed to load JSON: ${e.message}`;
    }
  });
</script>
