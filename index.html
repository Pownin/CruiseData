<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cruise Data Viewer</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; max-width: 1100px; margin: 0 auto; }
    h2 { margin: 0 0 10px 0; }
    input { width: 100%; padding: 10px; font-size: 16px; margin: 12px 0; box-sizing: border-box; }
    button { padding: 8px 12px; font-size: 14px; cursor: pointer; }
    .row { padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin: 10px 0; }
    .meta { opacity: 0.8; font-size: 14px; margin-top: 6px; }
    .topbar { display:flex; align-items:center; gap:10px; margin-bottom:10px; flex-wrap: wrap; }
    .status { opacity:.85; }
    .hint { opacity:.7; font-size: 13px; margin-top: 2px; }
    a { text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h2>Cruise Data</h2>

  <div class="topbar">
    <button id="load">Load JSON</button>
    <span id="status" class="status"></span>
  </div>

  <input id="q" placeholder="Search anything (ship, destination, dates, ports)..." disabled />
  <div class="hint">Tip: results are limited to the first 500 matches for speed.</div>

  <div id="out"></div>

  <script>
    let DATA = [];

    const loadBtn = document.getElementById("load");
    const q = document.getElementById("q");
    const out = document.getElementById("out");
    const status = document.getElementById("status");

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function textOf(item) {
      try { return JSON.stringify(item).toLowerCase(); }
      catch { return ""; }
    }

    function pickFirst(obj, keys) {
      for (const k of keys) {
        if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
      }
      return "";
    }

    function render(list) {
  out.innerHTML = "";
  const frag = document.createDocumentFragment();

  const capped = list.slice(0, 500);

  capped.forEach((item, idx) => {
    const title = pickFirst(item, ["title", "name", "itineraryName", "cruiseName"]);
    const region = pickFirst(item, ["region"]);

    // Fix: duration might be an object; handle both string and object cases
    let durationVal = item.duration;
    let duration = "";
    if (typeof durationVal === "string") duration = durationVal;
    else if (durationVal && typeof durationVal === "object") {
      // try common object keys
      duration = pickFirst(durationVal, ["text", "label", "value"]);
      if (!duration) duration = ""; // don't show [object Object]
    }

    // ✅ The important part: show all date ranges
    const dateRanges = Array.isArray(item.dateRanges) ? item.dateRanges : [];
    const datesTextFallback = pickFirst(item, ["dateRangeText", "date", "startDate", "sailDate", "departureDate"]);
    const journey = pickFirst(item, ["journeyText"]);
    const url = pickFirst(item, ["viewDetailsUrl", "viewDetailsHref", "url", "link"]);
    const img = pickFirst(item, ["imageUrl"]);

    const safeUrl = (typeof url === "string" && url.startsWith("http")) ? url : "";
    const safeImg = (typeof img === "string" && img.startsWith("http")) ? img : "";

    const div = document.createElement("div");
    div.className = "row";

    // Build date chips / list
    const MAX_DATES_SHOWN = 6;
    const hasManyDates = dateRanges.length > MAX_DATES_SHOWN;
    const shownDates = hasManyDates ? dateRanges.slice(0, MAX_DATES_SHOWN) : dateRanges;
    const hiddenDates = hasManyDates ? dateRanges.slice(MAX_DATES_SHOWN) : [];

    const datesHtml = (dateRanges.length > 0)
      ? `
        <div class="meta" style="margin-top:8px;">
          <div style="font-weight:600; opacity:.9; margin-bottom:4px;">Available dates:</div>
          <div style="display:flex; flex-wrap:wrap; gap:6px;">
            ${shownDates.map(d => `<span style="border:1px solid #e5e5e5; padding:4px 8px; border-radius:999px; font-size:13px;">${escapeHtml(d)}</span>`).join("")}
            ${hasManyDates ? `<button data-toggle="${idx}" style="border:1px solid #ddd; background:#fff; padding:4px 8px; border-radius:999px; font-size:13px; cursor:pointer;">Show all (${dateRanges.length})</button>` : ""}
          </div>
          ${hasManyDates ? `
            <div id="more-${idx}" style="display:none; margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">
              ${hiddenDates.map(d => `<span style="border:1px solid #e5e5e5; padding:4px 8px; border-radius:999px; font-size:13px;">${escapeHtml(d)}</span>`).join("")}
            </div>
          ` : ``}
        </div>
      `
      : (datesTextFallback ? `<div class="meta" style="margin-top:8px;"><b>Dates:</b> ${escapeHtml(datesTextFallback)}</div>` : "");

    div.innerHTML = `
      <div style="display:flex; gap:12px; align-items:flex-start;">
        ${safeImg ? `<img src="${escapeHtml(safeImg)}" alt="" style="width:120px;height:auto;border-radius:10px;border:1px solid #eee;">` : ""}
        <div style="flex:1;">
          <div><b>${escapeHtml(title || "Cruise")}</b></div>

          ${safeUrl ? `<div style="margin-top:6px;"><a href="${escapeHtml(safeUrl)}" target="_blank" rel="noopener">Open View Details</a></div>` : ""}

          <div class="meta">
            ${region ? `${escapeHtml(region)} · ` : ""}
            ${duration ? `${escapeHtml(duration)} · ` : ""}
          </div>

          ${journey ? `<div class="meta">${escapeHtml(journey)}</div>` : ""}

          ${datesHtml}
        </div>
      </div>
    `;

    frag.appendChild(div);
  });

  out.appendChild(frag);
  status.textContent = `Showing ${capped.length} of ${list.length} matches`;

  // Wire up "Show all" toggles
  out.querySelectorAll("button[data-toggle]").forEach(btn => {
    btn.addEventListener("click", () => {
      const i = btn.getAttribute("data-toggle");
      const more = document.getElementById(`more-${i}`);
      if (!more) return;

      const isHidden = more.style.display === "none";
      more.style.display = isHidden ? "flex" : "none";
      btn.textContent = isHidden ? "Hide extra dates" : `Show all (${(DATA[i]?.dateRanges?.length) ?? ""})`;
    });
  });
}


    function filter() {
      const needle = q.value.trim().toLowerCase();
      if (!needle) return render(DATA);

      const filtered = DATA.filter(item => textOf(item).includes(needle));
      render(filtered);
    }

    q.addEventListener("input", filter);

    loadBtn.addEventListener("click", async () => {
      try {
        status.textContent = "Loading…";

        const res = await fetch("./cruiseDataNew.json", { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} (couldn't find cruiseDataNew.json)`);

        const raw = await res.json();

        if (Array.isArray(raw)) {
          DATA = raw;
        } else if (raw && Array.isArray(raw.items)) {
          DATA = raw.items;
        } else {
          const firstArrayKey = raw && typeof raw === "object"
            ? Object.keys(raw).find(k => Array.isArray(raw[k]))
            : null;

          if (firstArrayKey) DATA = raw[firstArrayKey];
          else throw new Error("Loaded JSON but couldn't find an array (expected raw.items).");
        }

        q.disabled = false;
        q.value = "";
        q.focus();
        render(DATA);

        status.textContent = `Loaded ${DATA.length} items`;
      } catch (e) {
        status.textContent = `Failed to load JSON: ${e.message}`;
      }
    });
  </script>
</body>
</html>

