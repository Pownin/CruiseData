<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cruise Data Viewer</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; max-width: 1100px; margin: 0 auto; }
    h2 { margin: 0 0 10px 0; }
    input { width: 100%; padding: 10px; font-size: 16px; margin: 12px 0; box-sizing: border-box; }
    button { padding: 8px 12px; font-size: 14px; cursor: pointer; }
    .row { padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin: 10px 0; }
    .meta { opacity: 0.8; font-size: 14px; margin-top: 6px; }
    .topbar { display:flex; align-items:center; gap:10px; margin-bottom:10px; flex-wrap: wrap; }
    .status { opacity:.85; }
    .hint { opacity:.7; font-size: 13px; margin-top: 2px; }
    a { text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h2>Cruise Data</h2>

  <div class="topbar">
    <button id="load">Load JSON</button>
    <span id="status" class="status"></span>
  </div>

  <input id="q" placeholder="Search anything (ship, destination, dates, ports)..." disabled />
  <div class="hint">Tip: results are limited to the first 500 matches for speed.</div>

  <div id="out"></div>

  <script>
    let DATA = [];

    const loadBtn = document.getElementById("load");
    const q = document.getElementById("q");
    const out = document.getElementById("out");
    const status = document.getElementById("status");

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function textOf(item) {
      try { return JSON.stringify(item).toLowerCase(); }
      catch { return ""; }
    }

    function pickFirst(obj, keys) {
      for (const k of keys) {
        if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
      }
      return "";
    }

    function render(list) {
      out.innerHTML = "";
      const frag = document.createDocumentFragment();

      const capped = list.slice(0, 500);

      capped.forEach(item => {
        // Your JSON fields (plus fallbacks)
        const title = pickFirst(item, ["title", "name", "itineraryName", "cruiseName"]);
        const region = pickFirst(item, ["region"]);
        const duration = pickFirst(item, ["duration"]);
        const dates = pickFirst(item, ["dateRangeText", "date", "startDate", "sailDate", "departureDate"]);
        const journey = pickFirst(item, ["journeyText"]);
        const url = pickFirst(item, ["viewDetailsUrl", "viewDetailsHref", "url", "link"]);
        const img = pickFirst(item, ["imageUrl"]);

        const safeUrl = (typeof url === "string" && url.startsWith("http")) ? url : "";
        const safeImg = (typeof img === "string" && img.startsWith("http")) ? img : "";

        const div = document.createElement("div");
        div.className = "row";

        div.innerHTML = `
          <div style="display:flex; gap:12px; align-items:flex-start;">
            ${safeImg ? `<img src="${escapeHtml(safeImg)}" alt="" style="width:120px;height:auto;border-radius:10px;border:1px solid #eee;">` : ""}
            <div style="flex:1;">
              <div><b>${escapeHtml(title || "Cruise")}</b></div>

              ${safeUrl ? `<div style="margin-top:6px;"><a href="${escapeHtml(safeUrl)}" target="_blank" rel="noopener">Open View Details</a></div>` : ""}

              <div class="meta">
                ${region ? `${escapeHtml(region)} · ` : ""}
                ${duration ? `${escapeHtml(duration)} · ` : ""}
                ${dates ? `${escapeHtml(dates)}` : ""}
              </div>

              ${journey ? `<div class="meta">${escapeHtml(journey)}</div>` : ""}
            </div>
          </div>
        `;

        frag.appendChild(div);
      });

      out.appendChild(frag);
      status.textContent = `Showing ${capped.length} of ${list.length} matches`;
    }

    function filter() {
      const needle = q.value.trim().toLowerCase();
      if (!needle) return render(DATA);

      const filtered = DATA.filter(item => textOf(item).includes(needle));
      render(filtered);
    }

    q.addEventListener("input", filter);

    loadBtn.addEventListener("click", async () => {
      try {
        status.textContent = "Loading…";

        const res = await fetch("./cruiseDataNew.json", { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} (couldn't find cruiseDataNew.json)`);

        const raw = await res.json();

        if (Array.isArray(raw)) {
          DATA = raw;
        } else if (raw && Array.isArray(raw.items)) {
          DATA = raw.items;
        } else {
          const firstArrayKey = raw && typeof raw === "object"
            ? Object.keys(raw).find(k => Array.isArray(raw[k]))
            : null;

          if (firstArrayKey) DATA = raw[firstArrayKey];
          else throw new Error("Loaded JSON but couldn't find an array (expected raw.items).");
        }

        q.disabled = false;
        q.value = "";
        q.focus();
        render(DATA);

        status.textContent = `Loaded ${DATA.length} items`;
      } catch (e) {
        status.textContent = `Failed to load JSON: ${e.message}`;
      }
    });
  </script>
</body>
</html>
