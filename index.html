<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cruise Data Viewer</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; max-width: 1000px; margin: 0 auto; }
    h2 { margin: 0 0 10px 0; }
    input { width: 100%; padding: 10px; font-size: 16px; margin: 12px 0; box-sizing: border-box; }
    button { padding: 8px 12px; font-size: 14px; cursor: pointer; }
    .row { padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin: 8px 0; }
    .meta { opacity: 0.8; font-size: 14px; margin-top: 6px; }
    .topbar { display:flex; align-items:center; gap:10px; margin-bottom:10px; flex-wrap: wrap; }
    .status { opacity:.8; }
    .hint { opacity:.7; font-size: 13px; margin-top: 2px; }
  </style>
</head>
<body>
  <h2>Cruise Data</h2>

  <div class="topbar">
    <button id="load">Load JSON</button>
    <span id="status" class="status"></span>
  </div>

  <input id="q" placeholder="Search anything (ship, destination, dates, ports)..." disabled />
  <div class="hint">Tip: results are limited to the first 500 matches for speed.</div>

  <div id="out"></div>

  <script>
    let DATA = [];

    const loadBtn = document.getElementById("load");
    const q = document.getElementById("q");
    const out = document.getElementById("out");
    const status = document.getElementById("status");

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function textOf(item) {
      try { return JSON.stringify(item).toLowerCase(); }
      catch { return ""; }
    }

    function pickFirst(obj, keys) {
      for (const k of keys) {
        if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
      }
      return "";
    }

    function render(list) {
      out.innerHTML = "";
      const frag = document.createDocumentFragment();

      const capped = list.slice(0, 500);

      capped.forEach(item => {
        // Try common field names; adjust if your JSON uses different ones.
        const url = pickFirst(item, ["viewDetailsUrl", "view_details_url", "view_details", "url", "link"]);
        const title = pickFirst(item, ["title", "name", "itineraryName", "cruiseName", "itinerary_title"]);
        const dates = pickFirst(item, ["date", "startDate", "sailDate", "departureDate", "start", "depart"]);

        const safeUrl = (typeof url === "string" && url.startsWith("http")) ? url : "";

        const div = document.createElement("div");
        div.className = "row";

        div.innerHTML = `
          <div><b>${escapeHtml(title || "Cruise")}</b></div>
          ${safeUrl ? `<div><a href="${escapeHtml(safeUrl)}" target="_blank" rel="noopener">Open View Details</a></div>` : `<div class="meta">No link found on this item</div>`}
          ${dates ? `<div class="meta">${escapeHtml(dates)}</div>` : ``}
        `;

        frag.appendChild(div);
      });

      out.appendChild(frag);
      status.textContent = `Showing ${capped.length} of ${list.length} matches`;
    }

    function filter() {
      const needle = q.value.trim().toLowerCase();
      if (!needle) return render(DATA);

      // Simple “search everything” filter
      const filtered = DATA.filter(item => textOf(item).includes(needle));
      render(filtered);
    }

    q.addEventListener("input", filter);

    loadBtn.addEventListener("click", async () => {
      try {
        status.textContent = "Loading…";

        // IMPORTANT: relative path so it works on GitHub Pages project sites
        // Put cruiseDataNew.json in the same folder as this index.html
        const res = await fetch("./cruiseDataNew.json", { cache: "no-store" });

        if (!res.ok) throw new Error(`HTTP ${res.status} (couldn't find cruiseDataNew.json)`);

        DATA = await res.json();

        if (!Array.isArray(DATA)) {
          // If your JSON is an object with an array inside, you can adjust this:
          // e.g. DATA = DATA.items; or DATA = DATA.results;
          throw new Error("JSON loaded, but it is not a top-level array. If your file is an object, tell me the key that contains the array.");
        }

        q.disabled = false;
        q.value = "";
        q.focus();
        render(DATA);

        status.textContent = `Loaded ${DATA.length} items`;
      } catch (e) {
        status.textContent = `Failed to load JSON: ${e.message}`;
      }
    });
  </script>
</body>
</html>
